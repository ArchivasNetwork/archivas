# Nginx configuration for seed.archivas.ai
# Reverse proxy to Archivas node RPC (localhost:8080)

# HTTP server - redirect to HTTPS + ACME challenge
server {
  listen 80;
  listen [::]:80;
  server_name seed.archivas.ai;

  # ACME challenge for Let's Encrypt
  location /.well-known/acme-challenge/ {
    root /var/www/seed;
  }

  # Redirect all other traffic to HTTPS
  location / {
    return 301 https://$host$request_uri;
  }
}

# HTTPS server - reverse proxy to node RPC
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name seed.archivas.ai;

  # TLS certificates (managed by certbot)
  ssl_certificate     /etc/letsencrypt/live/seed.archivas.ai/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/seed.archivas.ai/privkey.pem;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;
  ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';

  # Security headers
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header Referrer-Policy no-referrer-when-downgrade always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  # Compression
  gzip on;
  gzip_vary on;
  gzip_comp_level 6;
  gzip_types application/json text/plain application/javascript text/css;
  gzip_min_length 1000;

  # Timeouts
  proxy_connect_timeout 30s;
  proxy_send_timeout    60s;
  proxy_read_timeout    60s;

  # Disable large uploads (blockchain is read-heavy)
  client_max_body_size 1m;

  # /submit endpoint - POST only with CORS
  location = /submit {
    # Handle OPTIONS preflight
    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "POST,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type" always;
      add_header Access-Control-Max-Age 1728000 always;
      add_header Content-Length 0;
      return 204;
    }

    # Enforce POST method
    if ($request_method != 'POST') {
      add_header Allow "POST" always;
      return 405;
    }

    # CORS for POST
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "POST,OPTIONS" always;

    # Proxy headers
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Content-Type      application/json;

    # Forward to node
    proxy_pass http://127.0.0.1:8080;
  }

  # All other endpoints - permissive GET, proxy to node
  location / {
    # Handle OPTIONS preflight
    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET,POST,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type" always;
      add_header Access-Control-Max-Age 1728000 always;
      add_header Content-Length 0;
      return 204;
    }

    # CORS for all methods
    add_header Access-Control-Allow-Origin "*" always;

    # Proxy headers
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Forward to node RPC
    proxy_pass http://127.0.0.1:8080;

    # Disable buffering for streaming endpoints
    proxy_buffering off;
  }

  # Health check endpoint
  location = /health {
    add_header Access-Control-Allow-Origin "*" always;
    proxy_pass http://127.0.0.1:8080/healthz;
  }

  # Version endpoint
  location = /version {
    add_header Access-Control-Allow-Origin "*" always;
    proxy_pass http://127.0.0.1:8080/version;
  }

  # Access log
  access_log /var/log/nginx/seed.archivas.ai.access.log;
  error_log /var/log/nginx/seed.archivas.ai.error.log;
}

